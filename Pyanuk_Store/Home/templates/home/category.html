{% extends 'home/navigation.html' %}
{% load static %}

{% block title %}Категории{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'style/products.css' %}" type="text/css">

<div class="container">
    <h1>Категории</h1>
    {% for category in categories %}
        <div class="category">
            <h2>{{ category.name }}</h2>
            {% with products=category.products_set.all %}
                {% if products %}
                    <div class="products">
                        {% for product in products %}
                            <div class="product-card">
                                {% if product.image_url %}
                                    <img src="{{ product.image_url }}" alt="{{ product.name }}">
                                {% else %}
                                    <img src="https://via.placeholder.com/150" alt="Нет изображения">
                                {% endif %}
                                <h3>{{ product.name }}</h3>
                                <p>Производитель: {{ product.manufacturer.name }}</p>
                                <p class="price">{{ product.price }} ₽</p>
                                <button class="add-to-cart" data-product-id="{{ product.id }}">
                                    {% if product.id in cart_items %}
                                        Товар в корзине
                                    {% else %}
                                        Добавить в корзину
                                    {% endif %}
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-products">Нет товаров в этой категории.</p>
                {% endif %}
            {% endwith %}
        </div>
    {% empty %}
        <p class="no-products">Нет доступных категорий.</p>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addToCartButtons = document.querySelectorAll('.add-to-cart');
    addToCartButtons.forEach(button => {
        const productId = button.getAttribute('data-product-id');
        if (button.textContent.trim() === 'Товар в корзине') {
            button.disabled = true; // Отключаем кнопку, если товар уже в корзине
        }

        button.addEventListener('click', function() {
            fetch(`/add-to-cart/${productId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        const message = document.createElement('div');
                        message.className = 'auth-message';
                        message.textContent = data.error + ' Перейдите на страницу логина.';
                        message.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background-color: #ff4d4d; color: #ffffff; padding: 10px 20px; border-radius: 5px; z-index: 1000; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);';
                        document.body.appendChild(message);
                        setTimeout(() => message.remove(), 5000);
                    } else {
                        alert(data.message);
                        button.textContent = 'Товар в корзине';
                        button.disabled = true; // Отключаем кнопку после добавления
                        // Обновляем все кнопки на странице
                        addToCartButtons.forEach(btn => {
                            if (btn.getAttribute('data-product-id') === data.product_id.toString()) {
                                btn.textContent = 'Товар в корзине';
                                btn.disabled = true;
                            }
                        });
                    }
                })
                .catch(error => console.error('Ошибка:', error));
        });
    });
});
</script>
{% endblock %}